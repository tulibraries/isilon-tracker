<div id="<%= dom_id volume %>" data-controller="batch-actions">

  <h1 class="volume-name"><%= "Volume: #{volume.name}" %></h1>

  <!-- Flash Messages Container -->
  <div id="flash-messages"></div>

  <div id="tree-filter-row">
    <label for="tree-filter">Filter:</label>
    <input
      id="tree-filter"
      type="search"
      placeholder="Enter search pattern"
      autofocus
    />

    <button type="button" class="icon-button" title="Hide unmatched nodes">
      <i class="bi bi-filter-square search-icon"></i>
    </button>
    
    <!-- Assign To Button (for mixed selections) -->
    <button type="button" 
            id="assign-to-btn"
            class="btn btn-primary ms-3" 
            data-action="click->batch-actions#openAssignModal"
            style="display: none;">
      <i class="bi bi-person-plus me-1"></i>
      Assign All (<span data-batch-actions-target="selectedTotalCount">0</span>)
    </button>
    
    <!-- Folder Batch Actions Button (hidden initially) -->
    <button type="button" 
            id="folder-batch-actions-btn"
            class="btn btn-primary ms-3" 
            data-action="click->batch-actions#openFolderModal"
            style="display: none;">
      <i class="bi bi-folder-fill me-1"></i>
      Assign Folders (<span data-batch-actions-target="selectedFolderCount">0</span>)
    </button>
    
    <!-- Asset Batch Actions Button (hidden initially) -->
    <button type="button" 
            id="asset-batch-actions-btn"
            class="btn btn-primary ms-3" 
            data-action="click->batch-actions#openAssetModal"
            style="display: none;">
      <i class="bi bi-file-earmark-fill me-1"></i>
      Update Assets (<span data-batch-actions-target="selectedAssetCount">0</span>)
    </button>
  </div>

  <div
    id="tree"
    class="wb-tree isilon-tree"
    data-controller="wunderbaum"
    data-wunderbaum-url-value="<%= file_tree_volume_path(volume.id) %>"
    data-wunderbaum-volume-id-value="<%= volume.id %>" 
    style="height: 500px;"
  ></div>

  <!-- Asset Batch Actions Modal -->
  <div class="modal fade" id="assetBatchActionsModal" tabindex="-1" aria-labelledby="assetBatchActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="assetBatchActionsModalLabel">
              Batch Update <span data-batch-actions-target="selectedAssetCount">0</span> Selected Assets
            </h5>
            <p class="text-muted mb-0 small">These options will only update selected assets</p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= form_with url: volume_batch_actions_path(volume), method: :patch, 
                        class: "batch-actions-form",
                        data: { 
                          "batch-actions-target": "form",
                          "action": "submit->batch-actions#submitBatchAction"
                        },
                        local: false do |form| %>
            
            <p class="text-muted mb-4">
              Update any or all of the fields below. Only fields with changes will be applied to the selected assets.
            </p>
            
            <!-- Hidden field for selected asset IDs -->
            <%= form.hidden_field :asset_ids, data: { "batch-actions-target": "assetIds" } %>
            
            <!-- Migration Status Update -->
            <div class="mb-4">
              <label class="form-label fw-bold">Migration Status</label>
              <%= form.select :migration_status_id, 
                    options_for_select([['Unchanged', '']] + MigrationStatus.all.map { |ms| [ms.name, ms.id] }, ''), 
                    {}, 
                    { class: "form-select" } %>
              <div class="form-text">Select a new migration status for the selected assets</div>
            </div>
            
            <!-- Assigned User Update -->
            <div class="mb-4">
              <label class="form-label fw-bold">Assigned User</label>
              <%= form.select :assigned_user_id, 
                    options_for_select([['Unchanged', ''], ['Unassigned', 'unassigned']] + User.all.map { |u| [u.display_name, u.id] }, ''), 
                    {}, 
                    { class: "form-select" } %>
              <div class="form-text">Assign or reassign the selected assets to a user</div>
            </div>
            
            <!-- ASpace Collection Update -->
            <div class="mb-4">
              <label class="form-label fw-bold">ASpace Collection</label>
              <%= form.select :aspace_collection_id, 
                    options_for_select([['Unchanged', '']] + AspaceCollection.all.map { |ac| [ac.name, ac.id] }, ''), 
                    {}, 
                    { class: "form-select" } %>
              <div class="form-text">Set the ASpace collection for the selected assets</div>
            </div>
            
            <!-- ASpace Linking Status Update -->
            <div class="mb-4">
              <label class="form-label fw-bold d-block">ASpace Linking Status</label>
              <div class="form-check form-check-inline">
                <%= form.radio_button :aspace_linking_status, '', 
                      { class: "form-check-input", checked: true, id: "aspace_linking_unchanged" } %>
                <label class="form-check-label" for="aspace_linking_unchanged">Unchanged</label>
              </div>
              <div class="form-check form-check-inline">
                <%= form.radio_button :aspace_linking_status, 'true', 
                      { class: "form-check-input", id: "aspace_linking_true" } %>
                <label class="form-check-label" for="aspace_linking_true">Linked</label>
              </div>
              <div class="form-check form-check-inline">
                <%= form.radio_button :aspace_linking_status, 'false', 
                      { class: "form-check-input", id: "aspace_linking_false" } %>
                <label class="form-check-label" for="aspace_linking_false">Not Linked</label>
              </div>
              <div class="form-text">Set the ASpace linking status for the selected assets</div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <%= form.submit "Apply Asset Updates", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Folder Batch Actions Modal -->
  <div class="modal fade" id="folderBatchActionsModal" tabindex="-1" aria-labelledby="folderBatchActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="folderBatchActionsModalLabel">
              Batch Update <span data-batch-actions-target="selectedFolderCount">0</span> Selected Folders
            </h5>
            <p class="text-muted mb-0 small">These options will only update selected folders</p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <%= form_with url: volume_batch_actions_path(volume), method: :patch, 
                        class: "folder-batch-actions-form",
                        data: { 
                          "batch-actions-target": "folderForm",
                          "action": "submit->batch-actions#submitFolderBatchAction"
                        },
                        local: false do |form| %>
            
            <p class="text-muted mb-4">
              Update the assigned user for the selected folders. Changes will not cascade to assets within the selected folders.
            </p>
            
            <!-- Hidden field for selected folder IDs -->
            <%= form.hidden_field :folder_ids, data: { "batch-actions-target": "folderIds" } %>
            
            <!-- Assigned User Update -->
            <div class="mb-4">
              <label class="form-label fw-bold">Assigned User</label>
              <%= form.select :assigned_user_id, 
                    options_for_select([['Unchanged', ''], ['Unassigned', 'unassigned']] + User.all.map { |u| [u.display_name, u.id] }, ''), 
                    {}, 
                    { class: "form-select" } %>
              <div class="form-text">Assign or reassign the selected folders (and all their contents) to a user</div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <%= form.submit "Apply Folder Updates", class: "btn btn-warning" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign To Modal (for mixed folder/asset selections) -->
  <div class="modal fade" id="assignToModal" tabindex="-1" aria-labelledby="assignToModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="assignToModalLabel">
            Assign Selection
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <%= form_with url: volume_batch_actions_path(volume), method: :patch, 
                        class: "assign-to-form",
                        data: { 
                          "batch-actions-target": "assignForm",
                          "action": "submit->batch-actions#submitAssignAction"
                        },
                        local: false do |form| %>
            
            <div class="alert alert-info mb-4">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Mixed selection assignment</strong>
              <div class="mt-2">
                <span class="badge bg-primary me-2" id="assign-folder-count">0 folders</span>
                <span class="badge bg-success" id="assign-asset-count">0 assets</span>
              </div>
            </div>
            
            <!-- Hidden fields for selected IDs -->
            <%= form.hidden_field :folder_ids, data: { "batch-actions-target": "assignFolderIds" } %>
            <%= form.hidden_field :asset_ids, data: { "batch-actions-target": "assignAssetIds" } %>
            
            <!-- Assigned User Selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Assign To</label>
              <%= form.select :assigned_user_id, 
                    options_for_select([['Unassigned', 'unassigned']] + User.all.map { |u| [u.display_name, u.id] }), 
                    { prompt: 'Select user...' }, 
                    { class: "form-select", required: true } %>
              <div class="form-text">All selected folders and assets will be assigned to this user</div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <%= form.submit "Assign", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

</div>